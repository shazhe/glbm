---
title: "Exp2a -- Update Steric"
author: "Z Sha"
date: "3 January 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
wd <-"C:/ZSwork/"
dd <-"Z:/"

library(rgdal); library(sp);library(GEOmap)
library(INLA)
library(ncdf4)
library(gstat)
source(paste0(wd,"glbm/BHM_sphere/functions.R"))
source(paste0(wd, "glbm/BHM_sphere/partition_fun.R"))

## Genereate Fibonacci points on the sphere
fibo_points <- fiboSphere(N = 12960, L0 = TRUE)
fibo_points_xyz <- do.call(cbind, Lll2xyz(lat = fibo_points[,2], lon = fibo_points[,1]))
mesh0 <- inla.mesh.2d(loc = fibo_points_xyz, cutoff = 0.01, max.edge = 1)
## Make this "smoother"
mesh0 <- inla.mesh.2d(loc = mesh0$loc, cutoff = 0.01, max.edge = 1)
```

# [Introduction](Exp2a1)

# [Update the sum of mass and GIA](Exp2a2)

# [Separate mass and GIA process](Exp2a3)

# Update $X_{steric}$

In this experiment, steric can be represented by SSH, MASS and GIA. 
$$X_{steric} = X_{SSH} - X_{MASS} - x_{GIA}$$
Since these processes are all Gaussian, the are additive. We have 
$$E(X_{steric} | Y_{alt}, Y_{GRACE}, X_{GIA} = x_{GIA}) = E(X_{SSH}| ) - E(X_{mass}|Y_{GRACE}) - x_{GIA} = E(X_{SSH}| ) - E(X_M|Y_{GRACE})\\
V(X_{steric}| Y_{alt}, Y_{GRACE}, X_{GIA} = x_{GIA}) = V(X_{SSH}| Y_{alt}) + V(X_{mass}|Y_{GRACE})= V(X_{SSH}| Y_{alt}) + V(X_{M}|Y_{GRACE})$$

## Load updated processes
```{r up_pro}
load(paste0(dd, "WP1-BHM/Experiment2a/exp2a_ssh.RData"))
load(paste0(dd, "WP1-BHM/Experiment2a/exp2a_M.RData"))
```

## Results

Now assemble the predicted mean of and uncertainty of steric at 1 degree resolution.
```{r setric}
steric_m <- res_SSH$SSH_pred$mean - res_M$M_pred$mean
steric_u <- res_SSH$SSH_pred$u + res_M$M_pred$u
steric_data <- data.frame(lon = res_SSH$SSH_pred$lon, lat = res_SSH$SSH_pred$lat, mean = steric_m, u = steric_u)

```

Plot the steric map.
```{r plot_steric}
lattice::levelplot(mean ~ lon + lat, data = steric_data, aspect = "iso",  at = seq(-5, 5, 1),
                     panel = function(x,y,z,...){
                       lattice::panel.levelplot(x,y,z,...)
                       map2 <- map("world2", interior = FALSE, plot = FALSE)
                       lattice::panel.xyplot(x=map2$x, y=map2$y, type = "l", col = "black")
                     },
                     main = title, xlab = "longitude", ylab = "latitude")

lattice::levelplot(u ~ lon + lat, data = steric_data, aspect = "iso", at = seq(0, 4, 0.5),
                     panel = function(x,y,z,...){
                       lattice::panel.levelplot(x,y,z,...)
                       map2 <- map("world2", interior = FALSE, plot = FALSE)
                       lattice::panel.xyplot(x=map2$x, y=map2$y, type = "l", col = "black")
                     },
                     main = title, xlab = "longitude", ylab = "latitude")
```

# Compare with other steric results

We compare the steric prediction with other four steric solutions.

```{r load_steric}
steric_files <- system(paste("ls", paste0(dd,"WP3-Ocean/BHMinputs/steric/")), intern = TRUE)
steric_models <- c("EN4", "IFEMER", "JAMSTEC", "SCRIPPS", "BHM")

steric_read <- function(file, name){
  filen <- paste0(dd,"WP3-Ocean/BHMinputs/steric/", file)
  steric_nc <- nc_open(filen)
  print(steric_nc)
  lon <-  ncvar_get(steric_nc, "LONGITUDE")
  lon <- ifelse(lon < 0, lon + 360, lon)
  lon <- ifelse(lon > 360, lon - 360, lon)
  lat <- ncvar_get(steric_nc, "LATITUDE")
  grid <- expand.grid(lon, lat)
  trend <- ncvar_get(steric_nc, "trend") #note that there re NAs for land datat
  err <- ncvar_get(steric_nc, "err")
  steric_data <- data.frame(trend = as.numeric(trend), err = as.numeric(err), 
                            model = name, lon = grid[,1], lat = grid[,2])
  nc_close(steric_nc)
  return(steric_data)
}

sterics <- list()

for (i in 1:4){
  sterics[[i]] <- steric_read(steric_files[i], steric_models[i])
}

steric_all <- do.call(rbind, sterics)
steric_bhm <- data.frame(trend = steric_data$mean, err = steric_data$u, 
                         model = "BHM", lon = steric_data$lon, lat = steric_data$lat)
steric_all <- rbind(steric_all, steric_bhm)

```

Now plot and compare the mean trend.
```{r mean_steric}
steric_plot <- steric_all
steric_plot$trend <- ifelse(abs(steric_plot$trend) > 5, sign(steric_plot$trend)*5.5, steric_plot$trend)
steric_plot$err <- ifelse(steric_plot$err > 5, 5.1, steric_plot$err)

lattice::levelplot(trend ~ lon + lat|model, data = steric_plot, aspect = "iso",  
                     panel = function(x,y,z,...){
                       lattice::panel.levelplot(x,y,z,...)
                       map2 <- map("world2", interior = FALSE, plot = FALSE)
                       lattice::panel.xyplot(x=map2$x, y=map2$y, type = "l", col = "black")
                     },
                     main = title, xlab = "longitude", ylab = "latitude")

lattice::levelplot(err ~ lon + lat|model, data = steric_plot, aspect = "iso",  
                     panel = function(x,y,z,...){
                       lattice::panel.levelplot(x,y,z,...)
                       map2 <- map("world2", interior = FALSE, plot = FALSE)
                       lattice::panel.xyplot(x=map2$x, y=map2$y, type = "l", col = "black")
                     },
                     main = title, xlab = "longitude", ylab = "latitude")
```

